# Kapital Sheet Urgut Bot

Telegram бот для управления финансовыми операциями с интеграцией в Google Sheets.

## Изменения в новой версии

Бот был обновлен для работы с новым Google Sheet, который имеет следующую структуру:

| Столбец | Название | Описание |
|---------|----------|----------|
| A | Сана | Дата в формате DD.MM.YYYY |
| B | Кирим | Сумма дохода |
| C | Чиқим | Сумма расхода |
| D | остатка | Остаток (не используется) |
| E | Котегория | Категория операции |
| F | Изох | Комментарий к операции |
| G | Объект номи | Название объекта/проекта |

## Процесс работы бота

1. **Выбор типа операции**: Пользователь выбирает между "Kirim" (доход) и "Chiqim" (расход)
2. **Ввод суммы**: Пользователь вводит сумму операции
3. **Выбор категории**: Пользователь выбирает категорию из списка кнопок
4. **Ввод комментария**: Пользователь вводит комментарий или пропускает
5. **Выбор объекта**: Пользователь выбирает объект из списка кнопок
6. **Подтверждение**: Пользователь подтверждает данные перед отправкой

## Система запросов

### Запрос новой категории:
- Пользователь отправляет `/request_category`
- Вводит название категории
- Админ получает уведомление с кнопками одобрения/отклонения
- После одобрения категория автоматически добавляется в список кнопок

### Запрос нового объекта:
- Пользователь отправляет `/request_object`
- Вводит название объекта
- Объект сразу добавляется в список кнопок
- Админы получают уведомление о новом объекте

## Команды бота

### Для всех пользователей:
- `/start` - Начать новую операцию
- `/register` - Регистрация нового пользователя
- `/request_category` - Отправить запрос на добавление новой категории
- `/request_object` - Добавить новый объект
- `/reboot` - Начать операцию заново

### Только для админов:
- `/test_sheets` - Проверить подключение к Google Sheets
- `/add_category` - Добавить новую категорию
- `/del_category` - Удалить категорию
- `/edit_category` - Редактировать категорию
- `/category_requests` - Просмотр запросов на категории
- `/object_requests` - Просмотр запросов на объекты
- `/userslist` - Список пользователей
- `/block_user` - Заблокировать пользователя
- `/approve_user` - Одобрить пользователя

## Настройка

1. Создайте файл `.env` с переменными окружения:
```env
BOT_TOKEN=your_telegram_bot_token
POSTGRES_DB=kapital
POSTGRES_USER=postgres
POSTGRES_PASSWORD=your_password
POSTGRES_HOST=localhost
POSTGRES_PORT=5432
```

2. Убедитесь, что у вас есть файл `credentials.json` для доступа к Google Sheets API

3. Установите зависимости:
```bash
pip install -r requirements.txt
```

4. Запустите бота:
```bash
python bot.py
```

## Особенности

- Автоматическое определение столбцов Кирим/Чиқим в зависимости от типа операции
- Автоматическое заполнение даты в формате DD.MM.YYYY
- Система одобрения пользователей администраторами
- Управление категориями через админ-панель
- **Система запросов на новые категории** - пользователи могут запрашивать добавление новых категорий
- **Система запросов на новые объекты** - пользователи могут запрашивать добавление новых объектов
- **Автоматическое одобрение категорий и объектов** - админы могут одобрять или отклонять запросы
- **Кнопки для выбора объектов** - вместо ручного ввода пользователи выбирают объект из списка кнопок
- Интеграция с PostgreSQL
- Уведомления администраторов о новых операциях и запросах

## Система миграций

Бот использует систему миграций для управления структурой базы данных и данными:

### Основные команды миграций:
```bash
# Выполнить все миграции
python migrations.py migrate

# Просмотреть статус миграций
python migrations.py status

# Сбросить миграции (только для разработки)
python migrations.py reset
```

### Автоматическое выполнение:
- Миграции выполняются автоматически при запуске бота
- Система отслеживает выполненные миграции
- Новые миграции применяются только один раз

Подробная документация по миграциям: [MIGRATIONS_README.md](MIGRATIONS_README.md)

## Структура базы данных

### Таблица users
- id: SERIAL PRIMARY KEY
- user_id: BIGINT UNIQUE (Telegram ID пользователя)
- name: TEXT (Имя пользователя)
- phone: TEXT (Номер телефона)
- status: TEXT (Статус: pending, approved, blocked, denied)
- reg_date: TEXT (Дата регистрации)

### Таблица categories
- id: SERIAL PRIMARY KEY
- name: TEXT UNIQUE (Название категории)

### Таблица objects
- id: SERIAL PRIMARY KEY
- name: TEXT UNIQUE (Название объекта)

### Таблица category_requests
- id: SERIAL PRIMARY KEY
- user_id: BIGINT (ID пользователя, отправившего запрос)
- user_name: TEXT (Имя пользователя)
- category_name: TEXT (Название запрашиваемой категории)
- status: TEXT (Статус: pending, approved, denied)
- request_date: TEXT (Дата запроса)

### Таблица object_requests
- id: SERIAL PRIMARY KEY
- user_id: BIGINT (ID пользователя, отправившего запрос)
- user_name: TEXT (Имя пользователя)
- object_name: TEXT (Название запрашиваемого объекта)
- status: TEXT (Статус: pending, approved, denied)
- request_date: TEXT (Дата запроса)
